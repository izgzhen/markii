<h1 id="ui-analysis-examples">UI Analysis Examples</h1>
<h2 id="v1.0">v1.0</h2>
<p>a single entry-point whole-program with multi-exits. The problem is to find invocation of certain external APIs.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">main</span>() { <span class="co">// entry point</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>();</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>} <span class="co">// exit 1</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">f</span>() {</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (<span class="fu">rand</span>()) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">externalAPI</span>(); <span class="co">// target</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">exit</span>(); <span class="co">// exit 2</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Solution: build a Java call-graph using <code>main</code> as entry-point.</p>
<h2 id="v1.1">v1.1</h2>
<p>turn the whole program into an Service class which has lifecycle handlers (<code>onCreate</code>, <code>onFinish</code>) and event handler. onCreate handler or event handler might call lifecycle API <code>finish</code> to exit the service.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExampleService <span class="kw">extends</span> <span class="bu">Service</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">onCreate</span>() { <span class="kw">... </span>}</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">onFinish</span>() { <span class="kw">... </span>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">onBackPressed</span>(<span class="bu">Event</span> e) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span>.<span class="fu">finish</span>();</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The platform code is similar to a event loop:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="bu">Service</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> finished = <span class="kw">false</span>;</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">finish</span>() {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span>.<span class="fu">onFinish</span>();</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    finished = <span class="kw">true</span>;</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">main</span>() {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Service</span> s = <span class="kw">new</span> <span class="bu">Service</span>();</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    s.<span class="fu">onCreate</span>();</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> (<span class="bu">Event</span> e : <span class="fu">waitEvent</span>() <span class="kw">if</span> (!s.<span class="fu">finished</span>)) {</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (e <span class="kw">instanceof</span> BackPressedEvent) {</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        s.<span class="fu">onBackPressed</span>(e);</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Solution: extra edges to turn iCFG to callback-iCFG. The context is still just simple java ones.</p>
<h2 id="v1.2">v1.2</h2>
<p>Introduce more Services that can call each other. One of them is MainService.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Service1 <span class="kw">extends</span> <span class="bu">Service</span> { <span class="kw">... </span>}</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Service2 <span class="kw">extends</span> <span class="bu">Service</span> { <span class="kw">... </span>}</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MainService <span class="kw">extends</span> <span class="bu">Service</span> {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">onBackPressed</span>(<span class="bu">Event</span> e) {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">startService</span>(Service1.<span class="fu">class</span>);</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>startService</code> API will “stack” the service calls and when the corresponding Service instance finished, the control flow will return back to the call-site. It is similar to call a function except that there are not args and <code>Service</code> has some built-in logic for lifecycles etc. Also, the event receiver context will change in that case as well.</p>
<p>Solution: model stack and use it as the context to determine event receiver, which in terms determine the callback-iCFG.</p>
<h2 id="v1.3">v1.3</h2>
<p>Introduce Dialog. Dialog is similar to a Service, except that it has a very simple and fixed UI structure that has a single button whose handler must be declared statically. Dialog is “showed” rather than created, but the meaning of API is similar. Also, Dialog has no lifecycle handlers. Its lifecycle finish API is called “dismiss”.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExampleDialog <span class="kw">extends</span> <span class="bu">Dialog</span> {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">onButtonClick</span>() {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span>.<span class="fu">dismiss</span>();</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MainService {</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">f</span>() {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">showDialog</span>(ExampleDialog.<span class="fu">class</span>);</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Extend window stack with Dialog as a frame.</p>
<h2 id="v1.4">v1.4</h2>
<p>Extend Dialog with dynamic allocation.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MainService {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">f</span>() {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Dialog</span> dialog = <span class="kw">new</span> <span class="fu">ExampleDialog</span>();</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        dialog.<span class="fu">show</span>();</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This needs us analyze the type of local variables to resolve the virtual call. Backslicing in the application iCFG should be sufficient. Then propagate.</p>
<h2 id="v1.5">v1.5</h2>
<p>Extend Dialog with <code>DialogBuilder</code> and dynamic handler update.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MainService {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">f</span>() {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Dialog</span> dialog = DialogBuilder.<span class="fu">create</span>();</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        dialog.<span class="fu">setButtonOnClickListener</span>(<span class="kw">new</span> <span class="fu">OnClickListener</span>() {</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">void</span> <span class="fu">onClick</span>(<span class="bu">Context</span> context) {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                ...</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                context.<span class="fu">finish</span>();</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        });</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        dialog.<span class="fu">show</span>();</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This requires tracking flow of anonymous <code>onClickListener</code> sub-class instance as part of control flow graph construction. Also, the <code>context</code> passed to the handler is the context Window, in this case, would be <code>dialog</code>. context can be <code>finsh</code>ed, and for <code>dialog</code>, that will be routed to its <code>dismiss</code>. But if <code>context</code> is an activity, the <code>finish</code> will be called.</p>
<p>Similarly, backslice and propagate. Needs passing “context” variable of <code>onClick</code> handler though, which should be sufficient if we know the window stack. (stack top will be the context).</p>
<h2 id="v1.6">v1.6</h2>
<p>Add static UI layout for Service. Each Service can select a static display. However, there will be no interaction on that display.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MainService {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">onCreate</span>() {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span>.<span class="fu">setContentView</span>(exampleLayoutId);</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>exampleLayoutId can be statically resolved to a XML-defined layout tree and there will be separate logic for abstracting and reasoning about the layout tree. Each node in that layout tree is a view. The root is also called root view of the associated service.</p>
<p>Require XML parsing and some layout model.</p>
<h2 id="v1.7">v1.7</h2>
<p>View with interaction components with statically declared handlers.</p>
<p>For example, Button view inside the XML can have a declared <code>onClick = ExampleOnClickListener</code>. <code>ExampleOnClickListener</code> is defined in code as a sub-class of <code>OnClickListener</code>.</p>
<p>In this case, the event receiver context will be able to process more types of input, e.g. click, which will be routed to the handler of clicked element. Also, that handler can start/show other service/dialog, or finish the <code>context</code>, in this case, would be the service associated with the root view of which layout tree the Button resides.</p>
<p>Require extending event receiver. This might impact callback-iCFG again.</p>
<h2 id="v1.8">v1.8</h2>
<p>Extend view with allocation and inflation.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MainService {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">onCreate</span>() {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">View</span> v = <span class="kw">new</span> <span class="bu">View</span>();</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (<span class="fu">rand</span>()) {</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        v.<span class="fu">inflate</span>(exampleLayoutId);</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span>.<span class="fu">setContentView</span>(v);</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This requires tracking of the <code>inflate</code> call. Backslice &amp; propagate.</p>
<h2 id="v1.9">v1.9</h2>
<p>Extend view with dynamic sub-view insertion and dynamic handler update.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MainService {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">onCreate</span>() {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">View</span> v = <span class="kw">new</span> <span class="fu">LinearLayout</span>();</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (<span class="fu">rand</span>()) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Button</span> b = <span class="kw">new</span> <span class="bu">Button</span>();</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        view.<span class="fu">addView</span>(b);</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        b.<span class="fu">setOnClickListener</span>(...)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span>.<span class="fu">setContentView</span>(v);</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This requires tracking of <code>addView</code> and <code>setOnClickListener</code> that updates the abstract view layout associated with local variables. Backslice &amp; propagate.</p>
